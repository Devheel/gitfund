#! /usr/bin/env python2

# Public Domain (-) 2017 The GitFund Authors.
# See the GitFund UNLICENSE file for details.

"""Script to create subscription plans using the Stripe API."""

import sys

from os import environ, pathsep
from os.path import dirname, isfile, join, realpath

app_path = join(dirname(dirname(realpath(__file__))), 'app')

gcloud_sdk = ""
for path in environ["PATH"].split(pathsep):
    file_path = join(path, 'dev_appserver.py')
    if isfile(file_path):
        gcloud_sdk = dirname(path)
        break
else:
    print "ERROR: Unable to locate dev_appserver.py on the $PATH."
    sys.exit(1)

sys.path.append(app_path)
sys.path.append(join(app_path, 'lib'))

import stripe
import stripe.http_client

from stripe.error import InvalidRequestError

sys.path.insert(0, join(gcloud_sdk, 'platform', 'google_appengine'))

from config import STRIPE_SECRET_KEY
from minfin import PLAN_AMOUNTS

stripe.api_key = STRIPE_SECRET_KEY

print ">> Creating stripe plans ..."

for plan_id, amount in sorted(PLAN_AMOUNTS.items(), key=lambda item: item[1]):
    try:
        plan = stripe.Plan.retrieve(plan_id)
    except InvalidRequestError:
        stripe.Plan.create(
            id=plan_id,
            amount=amount * 100,
            currency='GBP',
            interval='month',
            name='GitFund Monthly %s Sponsorship' % plan_id.title(),
            statement_descriptor='GITFUND'
            )
        print ".. created:", plan_id
